<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sharing common code across analyses • workflowr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Sharing common code across analyses">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">workflowr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.7.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../articles/wflow-01-getting-started.html">Getting started</a>
</li>
<li>
  <a href="../articles/wflow-05-faq.html">FAQ</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/workflowr/workflowr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Sharing common code across analyses</h1>
            <h3 data-toc-skip class="subtitle">workflowr version
1.7.2</h3>
                        <h4 data-toc-skip class="author">Tim Trice, John
Blischak</h4>
            
            <h4 data-toc-skip class="date">2025-08-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/workflowr/workflowr/blob/main/vignettes/wflow-07-common-code.Rmd" class="external-link"><code>vignettes/wflow-07-common-code.Rmd</code></a></small>
      <div class="hidden name"><code>wflow-07-common-code.Rmd</code></div>

    </div>

    
    
<p>During the course of a project, you may want to repeat a similar
analysis across multiple R Markdown files. To avoid duplicated code
across your files (which is difficult to update), there are multiple
strategies you can use to share common code:</p>
<ol style="list-style-type: decimal">
<li><p>To share R code like function definitions, you can put this code
in an R script and import it in each file with the function
<code><a href="https://rdrr.io/r/base/source.html" class="external-link">source()</a></code></p></li>
<li><p>To share common R Markdown text and code chunks, you can use <a href="https://yihui.org/knitr/demo/child/" class="external-link">child documents</a></p></li>
<li><p>To share common templates, you can use the function
<code><a href="https://rdrr.io/pkg/knitr/man/knit_expand.html" class="external-link">knitr::knit_expand()</a></code></p></li>
</ol>
<p>Each of these strategies is detailed below, with a special emphasis
on how to use them within the workflowr framework. In order to source
scripts or use child documents, it is suggested you use the <a href="https://cran.r-project.org/package=here" class="external-link">here</a> package, which
helps to locate the root directory of your project regardless of the
directory your script or analysis file is, making sourcing documents
cleaner.</p>
<div class="section level2">
<h2 id="overview-of-directories">Overview of directories<a class="anchor" aria-label="anchor" href="#overview-of-directories"></a>
</h2>
<p>First, a quick overview of the directories in a workflowr project.
This is critical for importing these shared files.</p>
<p>In a standard R Markdown file, the code is executed in the directory
where the R Markdown file is saved. Thus any paths to files in the R
Markdown file should be relative to this directory. However, the
directory where the code is executed, referred to as the “knit
directory” in the workflowr documentation, can be configured. The
default for a new workflowr project is to run the code in the root of
the workflowr project (this is defined in the file
<code>_workflowr.yml</code>; see <code><a href="../reference/wflow_html.html">?wflow_html</a></code> for
configuration details). Thus any filepaths should be relative to the
root of the project. As an example, if you have shared R functions
defined in the file <code>~/Desktop/myproject/code/common.R</code>, the
relative filepath from the root of the project directory would be
<code>"code/common.R"</code>.</p>
</div>
<div class="section level2">
<h2 id="share-r-code-with-source">Share R code with source()<a class="anchor" aria-label="anchor" href="#share-r-code-with-source"></a>
</h2>
<p>If you have R code you want to re-use across multiple R Markdown
files, the most straightforward option is to save this code in an R
script, e.g. <code>code/functions.R</code>.</p>
<p>Then in each R Markdown file that needs to use the code defined in
that file, you can use <code><a href="https://rdrr.io/r/base/source.html" class="external-link">source()</a></code> to load it. If the code in
your workflowr project is executed in the root of the project directory
(which is the default behavior for new workflowr projects), then you
would add the following chunk:</p>
<pre><code>```{r shared-code}
source("code/functions.R")
```</code></pre>
<p>On the other hand, if you have changed the value of
<code>knit_root_dir</code> in the file <code>_workflowr.yml</code>, you
need to ensure that the filepath to the R script is relative to this
directory. For example, if you set
<code>knit_root_dir: "analysis"</code>, you would use this code
chunk:</p>
<pre><code>```{r shared-code}
source("../code/functions.R")
```</code></pre>
<p>To avoid having to figure out the correct relative path (or having to
update it in the future if you were to change
<code>knit_root_dir</code>), you can use <code><a href="https://here.r-lib.org/reference/here.html" class="external-link">here::here()</a></code> as it
is always based off the project root. Additionally, it will help
readability when using child documents as discussed below.</p>
<pre><code>```{r shared-code}
source(here::here("code/functions.R"))
```</code></pre>
</div>
<div class="section level2">
<h2 id="share-child-documents-with-chunk-option">Share child documents with chunk option<a class="anchor" aria-label="anchor" href="#share-child-documents-with-chunk-option"></a>
</h2>
<p>To share text and code chunks across R Markdown files, you can use <a href="https://yihui.org/knitr/demo/child/" class="external-link">child documents</a>, a
feature of the <a href="https://cran.r-project.org/package=knitr" class="external-link">knitr</a> package.</p>
<p>Here is a example of a simple R Markdown file that you can use to
test this feature. Note that it contains an H2 header, some regular
text, and a code chunk.</p>
<pre><code>## Header in child document

Text in child document.

```{r child-code-chunk}
str(mtcars)
```</code></pre>
<p>You can save this child document anywhere in the workflowr project
with one critical exception: it cannot be saved in the R Markdown
directory (<code>analysis/</code> by default) with the file extension
<code>.Rmd</code> or <code>.rmd</code>. This is because workflowr
expects every R Markdown file in this directory to be a standalone
analysis that has a 1:1 correspondence with an HTML file in the website
directory (<code>docs/</code> by default). We recommend saving child
documents in a subdirectory of the R Markdown directory,
e.g. <code>analysis/child/ex-child.Rmd</code>.</p>
<p>To include the content of the child document, you can reference it
using <code><a href="https://here.r-lib.org/reference/here.html" class="external-link">here::here()</a></code> in your chunk options.</p>
<pre><code>```{r parent, child = here::here("analysis/child/ex-child.Rmd")}
```</code></pre>
<p>However, this fails if you wish to include plots in the code chunks
of the child documents. It will not generate an error, but the plot will
be missing <a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. In a situation like this, you would want
to generate the plot within the parent R Markdown file or use
<code><a href="https://rdrr.io/pkg/knitr/man/knit_expand.html" class="external-link">knitr::knit_expand()</a></code> as described in the next section.</p>
</div>
<div class="section level2">
<h2 id="share-templates-with-knit_expand">Share templates with knit_expand()<a class="anchor" aria-label="anchor" href="#share-templates-with-knit_expand"></a>
</h2>
<p>If you need to pass parameters to the code in your child document,
then you can use <code><a href="https://rdrr.io/pkg/knitr/man/knit_expand.html" class="external-link">knitr::knit_expand()</a></code>. Also, this strategy
has the added benefit that it can handle plots in the child document.
However, this requires setting <code>knit_root_dir: "analysis"</code> in
the file <code>_workflowr.yml</code> for plots to work properly.</p>
<p>Below is an example child document with one variable to be expanded:
<code>{{title}}</code> refers to a species in the iris data set. The
value assigned will be used to filter the iris data set and label the
section, chunk, and plot. We will refer to this file as
<code>analysis/child/iris.Rmd</code>.</p>
<pre><code>
## {{title}}

```{r plot_{{title}}}
iris %&gt;%
  filter(Species == "{{title}}") %&gt;%
  ggplot() +
  aes(x = Sepal.Length, y = Sepal.Width) +
  geom_point() +
  labs(title = "{{title}}")
```</code></pre>
<p>To generate a plot using the species <code>"setosa"</code>, you can
expand the child document in a hidden code chunk:</p>
<pre><code>```{r, include = FALSE}
src &lt;- knitr::knit_expand(file = here::here("analysis/child/iris.Rmd"),
                          title = "setosa")
```</code></pre>
<p>and then later knit it using an inline code expression<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>:</p>
<p><code>`r knitr::knit(text = unlist(src))`</code></p>
<p>The convenience of using <code><a href="https://rdrr.io/pkg/knitr/man/knit_expand.html" class="external-link">knitr::knit_expand()</a></code> gives you
the flexibility to generate multiple plots along with custom headers,
figure labels, and more. For example, if you want to generate a scatter
plot for each Species in the <code>iris</code> datasets, you can call
<code><a href="https://rdrr.io/pkg/knitr/man/knit_expand.html" class="external-link">knitr::knit_expand()</a></code> within a <code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply()</a></code> or
<code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">purrr::map()</a></code> call:</p>
<pre><code>```{r, include = FALSE}
src &lt;- lapply(
  sort(unique(iris$Species)), 
  FUN = function(x) {
    knitr::knit_expand(
      file = here::here("analysis/child/iris.Rmd"), 
      title = x
    )
  }
)
```</code></pre>
<p>This example code loops through each unique <code>iris$Species</code>
and sends it to the template as the variable <code>title</code>.
<code>title</code> is inserted into the header, the chunk label, the
<code>dplyr::filter()</code>, and the title of the plot. This generates
three plots with custom plot titles and labels while keeping your
analysis flow clean and simple.</p>
<p>Remember to insert <code>knitr::knit(text = unlist(src))</code> in an
inline R expression as noted above to knit the code in the desired
location of your main document.</p>
<p>Read the <code><a href="https://rdrr.io/pkg/knitr/man/knit_expand.html" class="external-link">knitr::knit_expand()</a></code> vignette for more
information.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/vignette.html" class="external-link">vignette</a></span><span class="op">(</span><span class="st">"knit_expand"</span>, package <span class="op">=</span> <span class="st">"knitr"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="footnotes footnotes-end-of-document">
<hr>
<ol>
<li id="fn1"><p>The reason for this is very technical and requires more
understanding of how workflowr is implemented than is necessary to use
it effectively in the majority of cases. Whenever workflowr builds an R
Markdown file, it first copies it to a temporary directory so that it
can inject extra code chunks that implement some of its reproducibility
features. The figures in the child documents end up being saved there
and then lost.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Before calling <code><a href="https://rdrr.io/pkg/knitr/man/knit.html" class="external-link">knitr::knit()</a></code>, you’ll need
to load the dplyr and ggplot2 packages to run the code in this example
child document.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by John Blischak, Peter Carbonetto, Matthew Stephens.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
